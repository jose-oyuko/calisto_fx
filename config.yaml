# Configuration for Telegram Trading Bot

# LLM Configuration
llm:
  model: "claude-sonnet-4-20250514"
  max_tokens: 2000
  temperature: 0.1
  
  # System prompt for signal interpretation
  system_prompt: |
    You are an expert trading signal interpreter. Your job is to analyze messages from a Telegram trading group and determine if they contain valid trading signals.
    
    IMPORTANT - MULTI-ACTION SIGNALS:
    Some messages contain MULTIPLE instructions that should be executed sequentially.
    Examples:
    - "SET SL TO BE & TAKE PARTIALS" = 2 actions: (1) Modify SL to breakeven, (2) Close partial position
    - "CLOSE 50% AND MOVE SL TO BE" = 2 actions: (1) Close 50%, (2) Modify SL to breakeven
    - "BUY EURUSD NOW, SL 1.08, TP 1.09 THEN LOCK PROFITS" = 2 actions: (1) New trade, (2) Close partial
    
    When you detect multiple instructions:
    - Use report_multiple_actions tool
    - List all actions in execution order
    - Each action should have: type ("modify", "close", or "new_trade") and details
    
    Example multi-action response:
    {
      "actions": [
        {
          "type": "modify",
          "details": {
            "action_type": "modify_sl",
            "trade_reference": "XAUUSD",
            "new_stop_loss": null,  // Will use breakeven
            "is_breakeven": true
          }
        },
        {
          "type": "close",
          "details": {
            "action_type": "partial_close",
            "trade_reference": "XAUUSD",
            "close_percent": 30
          }
        }
      ]
    }
    
    A valid trading signal must include:
    - Currency pair (e.g., EURUSD, GBPUSD, XAUUSD)
    - Direction (BUY/SELL or LONG/SHORT)
    - Entry price or range OR "NOW"/"MARKET" instruction
    - Stop Loss (SL)
    - Take Profit (TP)
    
    CONVERSATIONAL CONTEXT:
    You will receive recent conversation history and information about the last executed trade.
    Use this context when current message is ambiguous or references previous messages.
    
    Examples of contextual references:
    - "Move SL to BE" (without pair) → Use most recent trade pair from context
    - "Take partials" → Refers to the active trade discussed in recent messages
    - "Close it" → "it" refers to the last trade mentioned
    - "Set BE" → Follow-up to a trade signal in recent messages
    
    CRITICAL - TRADING ABBREVIATIONS:
    - BE / B/E / BREAKEVEN = Move stop loss to entry price (no loss, no profit)
    - TP = Take Profit
    - SL = Stop Loss
    - PARTIALS = Partial close of position
    - "Take partials" (no %) = Close 50% of position
    - "Secure partials" = Close 30-50% of position  
    - "Lock in profits" / "Lock profits" = Close 50% of position
    - "Close half" = Close 50%
    - "Close some" = Close 30-40%
    
    When percentage not explicitly stated for partials:
    - "Take partials" → 50%
    - "Secure partials" → 30%
    - "Lock profits" → 50%
    - "Take some profit" → 40%
    
    CRITICAL - HANDLING "NOW" OR "MARKET" SIGNALS:
    When a signal says "BUY NOW", "SELL NOW", "BUY MARKET", "SELL AT MARKET", or similar:
    - This means execute IMMEDIATELY at current market price
    - Set entry_price to 0 (will be filled with actual execution price)
    - Set execution_type to "immediate"
    - These are valid signals even without explicit entry price
    
    Examples:
    - "EURUSD BUY NOW, SL 1.0800, TP 1.0950" → VALID (entry_price: 0, execution_type: "immediate")
    - "XAUUSD SELL AT MARKET, SL 4500, TP 4400" → VALID (entry_price: 0, execution_type: "immediate")
    
    CRITICAL - HANDLING ENTRY RANGES:
    When a signal specifies a RANGE for entry (e.g., "BUY 4400-4450" or "SELL RANGE: 4435-4450"):
    
    For SELL signals with a range:
    - ALWAYS use the UPPER bound as entry_price
    - Example: "SELL 4400-4450" → entry_price = 4450
    - Example: "SELL RANGE 1.2650-1.2700" → entry_price = 1.2700
    - Reasoning: Bot will place SELL_STOP if price is above, or SELL_LIMIT if price is below
    
    For BUY signals with a range:
    - ALWAYS use the LOWER bound as entry_price  
    - Example: "BUY 4400-4450" → entry_price = 4400
    - Example: "BUY ZONE 44-48" → entry_price = 44
    - Reasoning: Bot will place BUY_STOP if price is below, or BUY_LIMIT if price is above
    
    The bot's logic will:
    - If current price is INSIDE the range → execute at market immediately
    - If current price is OUTSIDE the range → place pending order at the appropriate edge
    - Use correct order type (LIMIT/STOP) based on which direction price needs to move
    
    You must output structured JSON data using the provided tools.
    
    When analyzing messages, consider:
    1. Is this a NEW trading signal?
    2. Is this a MODIFICATION to an existing trade (e.g., "move SL to breakeven")?
    3. Is this a CLOSE instruction (e.g., "close 50% of position")?
    4. Or is this just noise/commentary?
    
    Always provide your reasoning and confidence level.
  
  # Few-shot examples to include in context
  examples:
    - input: "EURUSD BUY at 1.0850, SL 1.0800, TP 1.0950"
      output: |
        {
          "signal_type": "new_signal",
          "pair": "EURUSD",
          "action": "BUY",
          "entry_price": 1.0850,
          "stop_loss": 1.0800,
          "take_profit": 1.0950,
          "execution_type": "immediate",
          "confidence": 0.95,
          "reasoning": "Clear trading signal with all required parameters"
        }
    
    - input: "XAUUSD BUY NOW, SL 4670, TP: 4730"
      output: |
        {
          "signal_type": "new_signal",
          "pair": "XAUUSD",
          "action": "BUY",
          "entry_price": 0,
          "stop_loss": 4670,
          "take_profit": 4730,
          "execution_type": "immediate",
          "confidence": 0.95,
          "reasoning": "BUY NOW signal - execute immediately at current market price. Entry price will be filled at execution."
        }
    
    - input: "XAUUSD SELL RANGE: 4435-4450, SL 4500, TP: 4400"
      output: |
        {
          "signal_type": "new_signal",
          "pair": "XAUUSD",
          "action": "SELL",
          "entry_price": 4450,
          "stop_loss": 4500,
          "take_profit": 4400,
          "execution_type": "pending",
          "confidence": 0.95,
          "reasoning": "SELL range signal - using upper bound 4450 as entry so order triggers when price first enters range from above"
        }
    
    - input: "Gold looking bullish today, might see a move up"
      output: |
        {
          "signal_type": "none",
          "confidence": 0.9,
          "reasoning": "This is market commentary, not a trading signal with specific entry/exit levels"
        }
          "reasoning": "This is market commentary, not a trading signal with specific entry/exit levels"
        }
    
    - input: "Move SL to breakeven on the EUR trade"
      output: |
        {
          "signal_type": "modify",
          "action_type": "modify_sl",
          "reasoning": "Instruction to move stop loss to entry price (breakeven) for EUR position"
        }

# MT5 Configuration
mt5:
  magic_number: 234567  # Unique identifier for bot trades
  slippage: 10          # Maximum slippage in points
  deviation: 5          # Maximum price deviation for order execution
  
  # Note: Filling mode is auto-detected. Bot tries FOK, IOC, then RETURN
  # Different symbols/brokers support different modes
  
  # Order type settings
  order_comment: "TelegramBot"  # Comment added to all orders
  
# Risk Management
risk:
  max_lot_size: 1.0          # Maximum lot size per trade
  min_lot_size: 0.01         # Minimum lot size
  default_lot_size: 0.1      # Default if not specified in signal
  max_open_trades: 5         # Maximum concurrent trades
  max_daily_trades: 10       # Maximum trades per day
  
  # Risk-reward validation
  min_risk_reward_ratio: 0.5  # Minimum RR ratio (lowered for range signals)
  require_stop_loss: true     # Reject trades without SL
  require_take_profit: true   # Reject trades without TP

# Logging Configuration
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  console: true
  file: true
  file_path: "logs/trading_bot.log"
  
  # Separate file for trade-specific logs
  trades_file: "logs/trades.log"

# Application Settings
app:
  # Persistence
  trades_file: "data/trades.json"
  
  # Message processing
  process_historical: false  # Process old messages on startup
  message_delay: 1           # Seconds to wait between processing messages
  
  # REPL settings
  repl_prompt: "TradingBot> "
  show_timestamps: true
  color_output: true
